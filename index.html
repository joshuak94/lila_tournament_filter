<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tounaments search</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

    <script id="tournment-template" type="text/x-handlebars-template">
        <table class="table">
            <thead>
                <tr>
                    <td>Name</td>
                    <td>Control</td>
                    <td>Starting in</td>
                    <td>Type</td>
                    <td>Limited rating</td>
                    <td>Owner</td>
                    <td>Players</td>
                    <td>Link</td>
                </tr>
            </thead>
            <tbody>
                {{#each tt}}
                <tr {{#if this.schedule.freq}}bgcolor="#ededed"{{/if}}>
                    <td>{{ this.fullName }}</td>
                    <td>{{ this.limitminutes }}+{{ this.clock.increment }}</td>
                    <td>{{ this.startingin }}</td>
                    <td>{{ this.perf.name }}</td>
                    <td>{{#if this.hasMaxRating }}Yes{{/if}}</td>
                    <td>{{ this.createdBy }}</td>
                    <td>{{ this.nbPlayers }}</td>
                    <td><a href="https://lichess.org/tournament/{{ this.id }}">Join</a></td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </script>
    <script>

        var type = 'Any';

        var tournaments = {};

        // callback for unuiqe function
        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        //callback for sort out specific tournament type
        function SortTournament(tournament) {
            if (type == 'Any') {
                return tournament;
            }
            else return tournament.perf.name == type
        }

        // seconds to string conversion function
        Number.prototype.toHHMMSS = function () {
            //var sec_num = parseInt(this, 10); // don't forget the second param
            var sec_num = this;
            var days = Math.floor(sec_num / 86400);
            sec_num = sec_num - (days * 86400);
            var hours = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = sec_num - (hours * 3600) - (minutes * 60);

            if (hours < 10) { hours = "0" + hours; }
            if (minutes < 10) { minutes = "0" + minutes; }
            if (seconds < 10) { seconds = "0" + seconds; }

            if (days == 0) {
                return hours + ':' + minutes + ':' + seconds;
            }
            else if (days == 1) {
                return days + ' day, ' + hours + ':' + minutes + ':' + seconds;
            }
            else {
                return days + ' days, ' + hours + ':' + minutes + ':' + seconds;
            }
        }

        // make templates
        var source = document.getElementById("tournment-template").innerHTML;
        var template = Handlebars.compile(source);

        // after DOM is loaded        
        document.addEventListener('DOMContentLoaded', () => {

            // set handler for sort btn
            document.getElementById("sort").onclick = () => {
                var status = $("#status :selected").text();
                type = $("#type :selected").text();
                var html = template({ tt: tournaments[status].filter(SortTournament) });
                $("#content").html(html);
                return false;
            }

            // fetch data 
            $.ajax({
                url: "https://lichess.org/api/tournament",
                data: {
                },
                success: function (result) {

                    var types = ['Any'];
                    tournaments = result;

                    tournaments.created.forEach(element => {
                        types.push(element.perf.name);
                        element.startingin = element.secondsToStart.toHHMMSS();
                        element.limitminutes = element.clock.limit / 60;
                    });
                    tournaments.started.forEach(element => {
                        types.push(element.perf.name);
                        element.startingin = "Running";
                        element.limitminutes = element.clock.limit / 60;
                    });
                    tournaments.finished.forEach(element => {
                        types.push(element.perf.name);
                        element.startingin = "Finished";
                        element.limitminutes = element.clock.limit / 60;
                    });
                    var unique_types = types.filter(onlyUnique);

                    var element = document.getElementById("type");
                    unique_types.forEach(el => {
                        var opt = document.createElement('option');
                        opt.text = el;
                        element.appendChild(opt);
                    });

                    var html = template({ tt: result.created });
                    document.getElementById("content").innerHTML = html;
                }
            });
        });
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="alert alert-secondary" role="alert">
            This is a simple Lichess.org tournament filtering form. Regular tournaments are marked in light grey.
        </div>
        <form>
            <div class="form-row">
                <div class="form-group col-md6">
                    <label for="status">Tournament status</label>
                    <select class="custom-select" id="status">
                        <option value="1">created</option>
                        <option value="2">started</option>
                        <option value="3">finished</option>
                    </select>
                </div>
                <div class="form-group col-md6">
                    <label for="type">Tournament type</label>
                    <select class="custom-select" id="type"></select>
                </div>
                <div class="form-group col-md6">
                    <label for="sort">Filter</label><br>
                    <input id="sort" type="button" class="btn btn-primary" value="Filter">
                </div>
            </div>

        </form>
        <div id="content"></div>
    </div>
</body>

</html>